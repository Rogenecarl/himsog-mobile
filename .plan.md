# Auth Infrastructure Implementation Plan

## Overview
Set up authentication infrastructure for React Native/Expo app connecting to a Next.js + Better Auth backend at `https://himsog.tech/`. Uses TanStack Query for state management and expo-secure-store for token persistence.

## API Endpoints
| Endpoint | Method | Description |
|----------|--------|-------------|
| /api/mobile/auth/login | POST | Returns JWT token + user |
| /api/mobile/auth/register | POST | Create new account |
| /api/mobile/auth/verify-email | POST | Verify with 6-digit OTP |
| /api/mobile/auth/resend-otp | POST | Resend verification OTP |
| /api/mobile/auth/me | GET | Get current user (Bearer token) |

---

## Files to Create

### 1. `lib/api.ts` - Axios Instance
- Create axios instance with base URL `https://himsog.tech`
- Request interceptor: attach Bearer token from SecureStore
- Response interceptor: handle 401 errors (clear token, redirect to login)

### 2. `lib/auth.ts` - Token Management
- `getToken()` - retrieve token from SecureStore
- `setToken(token)` - save token to SecureStore
- `removeToken()` - clear token from SecureStore
- Token key constant: `AUTH_TOKEN`

### 3. `types/auth.ts` - TypeScript Types
```typescript
interface User {
  id: string;
  email: string;
  name: string;
  emailVerified: boolean;
}

interface LoginRequest {
  email: string;
  password: string;
}

interface RegisterRequest {
  email: string;
  password: string;
  name: string;
}

interface AuthResponse {
  token: string;
  user: User;
}

interface VerifyEmailRequest {
  email: string;
  otp: string;
}

interface ResendOtpRequest {
  email: string;
}
```

### 4. `services/auth-service.ts` - API Calls
- `login(credentials)` - POST /api/mobile/auth/login
- `register(data)` - POST /api/mobile/auth/register
- `verifyEmail(data)` - POST /api/mobile/auth/verify-email
- `resendOtp(email)` - POST /api/mobile/auth/resend-otp
- `getMe()` - GET /api/mobile/auth/me

### 5. `hooks/use-auth.ts` - Auth Hook with TanStack Query
- `useAuth()` hook returning:
  - `user` - current user data
  - `isLoading` - loading state
  - `isAuthenticated` - boolean auth status
  - `login` - mutation for login
  - `register` - mutation for register
  - `logout` - function to clear auth state
  - `verifyEmail` - mutation for email verification
  - `resendOtp` - mutation for resending OTP

Query keys:
- `['auth', 'user']` - for user data

### 6. `providers/query-provider.tsx` - TanStack Query Setup
- QueryClientProvider wrapper
- Configure stale time, retry logic

---

## Files to Modify

### 7. `app/_layout.tsx` - Root Layout
- Wrap with QueryProvider
- Add auth state check for protected routes (optional - can be done later)

---

## Folder Structure After Implementation
```
lib/
  api.ts           # Axios instance with interceptors
  auth.ts          # Token storage utilities
types/
  auth.ts          # Auth-related TypeScript types
services/
  auth-service.ts  # Auth API calls
hooks/
  use-auth.ts      # TanStack Query auth hook
providers/
  query-provider.tsx  # QueryClient setup
```

---

## Implementation Order
1. `types/auth.ts` - Define types first
2. `lib/auth.ts` - Token storage utilities
3. `lib/api.ts` - Axios instance with interceptors
4. `services/auth-service.ts` - API call functions
5. `providers/query-provider.tsx` - Query client setup
6. `hooks/use-auth.ts` - Main auth hook
7. `app/_layout.tsx` - Integrate QueryProvider

---

## Notes
- Uses `expo-secure-store` (already installed) for secure token storage
- TanStack Query handles caching and background refetching of user data
- 401 responses automatically clear token and could trigger re-authentication
- All new files follow existing naming conventions (kebab-case)
